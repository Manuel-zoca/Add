<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîê Adicionar ao Grupo WhatsApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #5965e0, #7a57c5);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .session-controls {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .session-row {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    select, input[type="text"], textarea {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 1rem;
      width: 100%;
    }

    select {
      flex: 1;
      min-width: 200px;
    }

    textarea {
      resize: vertical;
      height: 100px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #6c63ff;
      color: white;
      flex: 1;
    }

    .btn-stop {
      background: #ff9800;
      color: white;
    }

    .btn-disconnect {
      background: #f44336;
      color: white;
    }

    .btn:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .links {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .qr-link {
      color: #6c63ff;
      background: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      text-decoration: none;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: rgba(255,255,255,0.15);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      backdrop-filter: blur(5px);
    }

    .stat-card strong {
      font-size: 1.4rem;
      display: block;
      margin-bottom: 4px;
    }

    .stat-card small {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .progress-container {
      margin: 15px 0;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 8px;
    }

    .progress-bar {
      height: 10px;
      background: #4caf50;
      border-radius: 5px;
      width: 0%;
      transition: width 0.4s ease;
    }

    .realtime-log {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .log-entry {
      margin: 8px 0;
      padding: 6px 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      word-break: break-word;
    }

    .log-number {
      font-weight: 600;
      color: #a0d8ff;
    }

    .status-success { color: #8bc34a; }
    .status-error { color: #ff7066; }
    .status-exists { color: #ffca28; }
    .status-info { color: #80d8ff; }

    .number-list {
      margin-top: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
    }

    .number-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.95rem;
    }

    .number-item:last-child {
      border-bottom: none;
    }

    .number-status {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-success { background: #4caf50; color: white; }
    .badge-error { background: #f44336; color: white; }
    .badge-exists { background: #ff9800; color: white; }
    .badge-pending { background: #607d8b; color: white; }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #aaa;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .session-row { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîê Adicionar ao Grupo WhatsApp</h1>
    </header>

    <div class="session-controls">
      <div class="session-row">
        <select id="sessionId" required></select>
        <button id="refreshSessions" class="btn btn-primary" style="width: auto;">üîÑ Atualizar</button>
      </div>

      <div class="links">
        <a href="#" id="qrLink" target="_blank" class="qr-link">üîó Escanear QR</a>
        <button id="stopBtn" class="btn btn-stop" style="display: none;">‚è∏ Parar Envios</button>
        <button id="disconnectBtn" class="btn btn-disconnect" style="display: none;">‚ùå Desconectar</button>
      </div>
    </div>

    <form id="groupForm">
      <label>ID do Grupo:</label>
      <input type="text" id="groupId" placeholder="1234567890@g.us" required />

      <label>N√∫meros (separados por v√≠rgula, espa√ßo ou quebra de linha):</label>
      <textarea id="numbers" placeholder="258875078026, 27797393529, 258848630908" required></textarea>

      <button type="submit" id="submitBtn" class="btn btn-primary">üöÄ Enviar para Fila</button>
    </form>

    <!-- Estat√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <strong id="totalQueued">0</strong>
        <small>Fila Total</small>
      </div>
      <div class="stat-card">
        <strong id="addedCount">0</strong>
        <small>‚úÖ Adicionados</small>
      </div>
      <div class="stat-card">
        <strong id="existsCount">0</strong>
        <small>üîÅ J√° no Grupo</small>
      </div>
      <div class="stat-card">
        <strong id="errorCount">0</strong>
        <small>‚ùå Falhas</small>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <strong id="estimatedTime">--</strong>
        <small>‚è±Ô∏è Pr√≥ximo Lote</small>
      </div>
      <div class="stat-card">
        <strong id="currentStatus">Desconectado</strong>
        <small>üì° Status</small>
      </div>
    </div>

    <!-- Lista de n√∫meros processados -->
    <div class="number-list">
      <h3>üìû N√∫meros Processados</h3>
      <div id="numberList">
        <div class="empty-state">Nenhum n√∫mero processado ainda.</div>
      </div>
    </div>

    <!-- Logs em tempo real -->
    <div class="realtime-log">
      <h3>üìã Logs em Tempo Real</h3>
      <div id="log"></div>
    </div>
  </div>

  <script>
    const sessionIdSelect = document.getElementById('sessionId');
    const qrLink = document.getElementById('qrLink');
    const stopBtn = document.getElementById('stopBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const submitBtn = document.getElementById('submitBtn');
    const groupForm = document.getElementById('groupForm');
    const groupIdInput = document.getElementById('groupId');
    const numbersInput = document.getElementById('numbers');
    const refreshSessionsBtn = document.getElementById('refreshSessions');

    const totalQueuedEl = document.getElementById('totalQueued');
    const addedCountEl = document.getElementById('addedCount');
    const existsCountEl = document.getElementById('existsCount');
    const errorCountEl = document.getElementById('errorCount');
    const estimatedTimeEl = document.getElementById('estimatedTime');
    const currentStatusEl = document.getElementById('currentStatus');
    const progressBar = document.getElementById('progressBar');
    const logEl = document.getElementById('log');
    const numberListEl = document.getElementById('numberList');

    let ws = null;
    let wsReconnectInterval = null;
    let wsPingInterval = null;
    let countdownInterval = null;

    let totalQueued = 0;
    let processedCount = 0;
    let addedCount = 0;
    let existsCount = 0;
    let errorCount = 0;
    let numberStatusMap = {};

    async function loadSessions() {
      try {
        const res = await fetch('/sessions');
        const sessions = await res.json();

        sessionIdSelect.innerHTML = '';
        if (sessions.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = 'Nenhuma sess√£o ativa';
          opt.disabled = true;
          sessionIdSelect.appendChild(opt);
          updateQrLink();
          return;
        }

        sessions.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.sessionId;
          opt.textContent = `${s.connected ? 'üü¢' : 'üî¥'} ${s.sessionId}`;
          sessionIdSelect.appendChild(opt);
        });

        if (sessions.length > 0) {
          sessionIdSelect.value = sessions[0].sessionId;
        }
        updateQrLink();
        connectWebSocket(sessionIdSelect.value);
      } catch (err) {
        console.error("Erro ao carregar sess√µes:", err);
        addLog("‚ùå Falha ao carregar sess√µes.", "error");
      }
    }

    function updateQrLink() {
      const selected = sessionIdSelect.value;
      if (!selected || selected === 'Nenhuma sess√£o ativa') {
        qrLink.href = '#';
        qrLink.textContent = 'üîó Nenhuma sess√£o';
        return;
      }
      qrLink.href = `/qr/${selected}`;
      qrLink.textContent = `üîó Escanear QR: ${selected}`;
    }

    function connectWebSocket(sessionId) {
      if (ws) {
        ws.close();
        clearInterval(wsPingInterval);
      }
      if (wsReconnectInterval) clearInterval(wsReconnectInterval);

      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const host = window.location.host;
      const wsUrl = `${protocol}//${host}/ws/${sessionId}`;

      console.log("üîå Tentando conectar:", wsUrl);
      currentStatusEl.textContent = "Conectando...";

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("üü¢ Conectado ao WebSocket");
        currentStatusEl.textContent = "Conectado ao servidor";
        clearInterval(wsReconnectInterval);

        wsPingInterval = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "ping" }));
          }
        }, 30_000);
      };

      ws.onclose = () => {
        console.log("üî¥ WebSocket fechado");
        clearInterval(wsPingInterval);
        currentStatusEl.textContent = "Desconectado";
        if (!wsReconnectInterval) {
          wsReconnectInterval = setInterval(() => {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
              connectWebSocket(sessionId);
            }
          }, 5000);
        }
      };

      ws.onerror = (err) => console.error("WebSocket error:", err);

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (!data.sessionId || data.sessionId !== sessionId) return;

        switch (data.type) {
          case "qr_code":
            currentStatusEl.textContent = "üì± Escaneie o QR";
            stopBtn.style.display = "none";
            disconnectBtn.style.display = "inline-block";
            clearStats();
            addLog("üì± Escaneie o QR para conectar.", "info");
            break;

          case "connected":
            currentStatusEl.textContent = "‚úÖ Conectado ao WhatsApp";
            stopBtn.style.display = "inline-block";
            disconnectBtn.style.display = "inline-block";
            addLog("‚úÖ WhatsApp conectado com sucesso.", "success");
            break;

          case "disconnected":
            currentStatusEl.textContent = "üî¥ Desconectado";
            stopBtn.style.display = "none";
            disconnectBtn.style.display = "none";
            clearInterval(countdownInterval);
            clearStats();
            addLog("üî¥ Desconectado do WhatsApp.", "error");
            break;

          case "batch_start":
            addLog(`üöÄ Iniciando lote de ${data.count} n√∫meros...`, "info");
            currentStatusEl.textContent = `Lote: ${data.count} n√∫meros`;
            break;

          case "number_processed":
            numberStatusMap[data.number] = data.status;
            processedCount++;
            if (data.status === "sucesso") addedCount++;
            else if (data.status === "ja_existe") existsCount++;
            else errorCount++;

            updateStats();
            renderNumberList();
            updateProgressBar();

            let msg = `üìû ${data.number} ‚Üí `;
            if (data.status === "sucesso") msg += "‚úÖ Adicionado";
            else if (data.status === "ja_existe") msg += "üîÅ J√° no grupo";
            else msg += "‚ùå " + (data.message || "Erro");

            addLog(msg, data.status === "sucesso" ? "success" : data.status === "ja_existe" ? "exists" : "error");
            break;

          case "waiting_minilote":
            addLog(`‚è≥ Aguardando 60s para pr√≥ximo mini-lote...`, "info");
            break;

          case "batch_done":
            if (data.nextAddInMs) {
              estimatedTimeEl.textContent = formatTime(data.nextAddInMs / 1000);
              startCountdown(data.nextAddInMs);
            }
            break;

          case "queue_completed":
            addLog("üéâ Fila conclu√≠da! Todos os n√∫meros foram processados.", "success");
            currentStatusEl.textContent = "Fila conclu√≠da";
            clearInterval(countdownInterval);
            break;

          case "stopped":
            addLog("‚è∏ Adi√ß√£o interrompida pelo usu√°rio.", "error");
            currentStatusEl.textContent = "Parado";
            clearInterval(countdownInterval);
            break;
        }
      };
    }

    function addLog(text, type = "info") {
      const entry = document.createElement('div');
      entry.className = `log-entry status-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      logEl.prepend(entry);
    }

    function renderNumberList() {
      if (Object.keys(numberStatusMap).length === 0) {
        numberListEl.innerHTML = '<div class="empty-state">Nenhum n√∫mero processado ainda.</div>';
        return;
      }

      numberListEl.innerHTML = '';
      Object.entries(numberStatusMap).forEach(([num, status]) => {
        const item = document.createElement('div');
        item.className = 'number-item';
        item.innerHTML = `
          <span class="log-number">${num}</span>
          <span class="number-status">
            <span class="status-badge ${
              status === 'sucesso' ? 'badge-success' :
              status === 'ja_existe' ? 'badge-exists' : 'badge-error'
            }">
              ${status === 'sucesso' ? 'Adicionado' : status === 'ja_existe' ? 'J√° no grupo' : 'Erro'}
            </span>
          </span>
        `;
        numberListEl.appendChild(item);
      });
    }

    function updateStats() {
      totalQueuedEl.textContent = totalQueued;
      addedCountEl.textContent = addedCount;
      existsCountEl.textContent = existsCount;
      errorCountEl.textContent = errorCount;
    }

    function clearStats() {
      processedCount = 0;
      addedCount = 0;
      existsCount = 0;
      errorCount = 0;
      numberStatusMap = {};
      updateStats();
      renderNumberList();
      progressBar.style.width = '0%';
    }

    function updateProgressBar() {
      const percent = totalQueued > 0 ? (processedCount / totalQueued) * 100 : 0;
      progressBar.style.width = `${percent}%`;
    }

    function startCountdown(ms) {
      clearInterval(countdownInterval);
      let s = Math.floor(ms / 1000);
      estimatedTimeEl.textContent = formatTime(s);

      countdownInterval = setInterval(() => {
        s--;
        if (s <= 0) {
          clearInterval(countdownInterval);
          estimatedTimeEl.textContent = "Pronto";
        } else {
          estimatedTimeEl.textContent = formatTime(s);
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}m ${s}s`;
    }

    sessionIdSelect.addEventListener('change', () => {
      updateQrLink();
      connectWebSocket(sessionIdSelect.value);
    });

    refreshSessionsBtn.addEventListener('click', loadSessions);

    stopBtn.addEventListener('click', async () => {
      const sessionId = sessionIdSelect.value;
      try {
        await fetch(`/stop/${sessionId}`, { method: 'POST' });
        addLog("‚è∏ Adi√ß√£o interrompida.", "error");
      } catch (err) {
        addLog("‚ùå Falha ao parar.", "error");
      }
    });

    disconnectBtn.addEventListener('click', async () => {
      const sessionId = sessionIdSelect.value;
      if (confirm(`Desconectar ${sessionId}?`)) {
        try {
          await fetch(`/disconnect/${sessionId}`, { method: 'POST' });
          addLog("üîì Conta desconectada.", "error");
        } catch (err) {
          addLog("‚ùå Falha ao desconectar.", "error");
        }
      }
    });

    groupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearInterval(countdownInterval);
      submitBtn.disabled = true;

      const sessionId = sessionIdSelect.value;
      const groupId = groupIdInput.value.trim();

      const rawNumbers = numbersInput.value
        .replace(/\s+/g, ',')
        .split(',')
        .map(n => n.trim())
        .filter(n => n && /^\d+$/.test(n));

      if (rawNumbers.length === 0) {
        alert("‚ùå Nenhum n√∫mero v√°lido encontrado.");
        submitBtn.disabled = false;
        return;
      }

      totalQueued = rawNumbers.length;
      processedCount = 0;
      addedCount = 0;
      existsCount = 0;
      errorCount = 0;
      numberStatusMap = {};
      updateStats();
      updateProgressBar();
      renderNumberList();

      try {
        const res = await fetch(`/adicionar/${sessionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId, numbers: rawNumbers })
        });

        const data = await res.json();
        if (res.ok) {
          addLog(`‚úÖ ${rawNumbers.length} n√∫meros enviados para a fila.`, "success");
        } else {
          addLog(`‚ùå Erro: ${data.error}`, "error");
        }
      } catch (err) {
        addLog(`‚ùå Falha de conex√£o: ${err.message}`, "error");
      } finally {
        submitBtn.disabled = false;
      }
    });

    loadSessions();
  </script>
</body>
</html>
