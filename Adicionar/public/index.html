<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adicionar ao Grupo WhatsApp</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      margin: 30px 0 15px;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .container {
      max-width: 600px;
      width: 100%;
    }
    form {
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 600;
      color: #ddd;
    }
    select, input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 1rem;
    }
    textarea { resize: vertical; }
    button {
      background: #6c63ff;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: background 0.3s;
    }
    button:disabled { background: #999; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #5750d1; }
    #status {
      margin-top: 15px;
      min-height: 20px;
      font-size: 0.9rem;
      text-align: center;
    }
    #liveStats {
      margin-top: 20px;
      text-align: center;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      width: 100%;
    }
    pre {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 0.9rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .qr-link, .ctrl-btn {
      color: #6c63ff;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 10px;
      text-decoration: none;
      display: inline-block;
    }
    .ctrl-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 6px 10px;
      margin-left: 10px;
      cursor: pointer;
    }
    .loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Adicionar ao Grupo WhatsApp</h2>

    <!-- Sele√ß√£o de conta -->
    <label>Selecione a Conta:</label>
    <select id="sessionId">
      <option value="conta1">üì± Conta 1</option>
      <option value="conta2">üì± Conta 2</option>
      <option value="conta3">üì± Conta 3</option>
      <option value="marketing">üì± Marketing</option>
      <option value="suporte">üì± Suporte</option>
    </select>

    <!-- Link QR + Bot√µes de controle -->
    <div style="text-align: center; margin: 10px 0;">
      <a href="/qr/conta1" target="_blank" id="qrLink" class="qr-link">üîó Escanear QR da Conta 1</a>
      <button id="stopBtn" class="ctrl-btn" style="display: none;">‚è∏ Parar Envios</button>
      <button id="disconnectBtn" class="ctrl-btn" style="display: none;">‚ùå Desconectar</button>
    </div>

    <!-- Formul√°rio -->
    <form id="groupForm">
      <label>ID do Grupo:</label>
      <input type="text" id="groupId" placeholder="1234567890@g.us" required />
      <label>N√∫meros (separados por v√≠rgula):</label>
      <textarea id="numbers" rows="4" placeholder="258840000000, 258870000000" required></textarea>
      <button type="submit" id="submitBtn">Enviar</button>
      <div id="status"></div>
    </form>

    <!-- Status em tempo real -->
    <div id="liveStats">
      <p>üì¶ Fila Total: <strong id="totalQueued">0</strong></p>
      <p>‚úÖ Adicionados: <strong id="addedCount">0</strong></p>
      <p>‚è≥ Restantes: <strong id="remainingCount">0</strong></p>
      <p>‚è±Ô∏è Pr√≥ximo Lote em: <strong id="estimatedTime">--</strong></p>
      <p>üöÄ Status Atual: <strong id="currentBatchStatus">Desconectado</strong></p>
    </div>

    <!-- Resultados -->
    <pre id="result"></pre>
  </div>

  <script>
    const form = document.getElementById('groupForm');
    const result = document.getElementById('result');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const stopBtn = document.getElementById('stopBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sessionIdSelect = document.getElementById('sessionId');
    const qrLink = document.getElementById('qrLink');

    const totalQueuedEl = document.getElementById('totalQueued');
    const addedCountEl = document.getElementById('addedCount');
    const remainingCountEl = document.getElementById('remainingCount');
    const estimatedTimeEl = document.getElementById('estimatedTime');
    const currentBatchStatusEl = document.getElementById('currentBatchStatus');

    let totalQueued = 0;
    let addedCount = 0;
    let ws = null;
    let wsReconnectInterval = null;
    let wsPingInterval = null;
    let countdownInterval = null;

    // Atualizar link do QR
    function updateQrLink() {
      const selected = sessionIdSelect.value;
      qrLink.href = `/qr/${selected}`;
      qrLink.textContent = `üîó Escanear QR da ${selected}`;
    }
    sessionIdSelect.addEventListener('change', updateQrLink);
    updateQrLink();

    // Conectar WebSocket com reconex√£o inteligente
    function connectWebSocket(sessionId) {
      if (ws) {
        ws.close();
        clearInterval(wsPingInterval);
      }
      if (wsReconnectInterval) clearInterval(wsReconnectInterval);

      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const host = window.location.host;
      const wsUrl = `${protocol}//${host}/ws/${sessionId}`;

      console.log("üîå Tentando conectar ao WebSocket:", wsUrl);
      status.textContent = "üîÑ Conectando ao servidor...";

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("üü¢ Conectado ao WebSocket");
        status.textContent = "‚úÖ Conectado ao sistema";
        if (wsReconnectInterval) clearInterval(wsReconnectInterval);
        wsReconnectInterval = null;

        // Envia ping a cada 30s para manter vivo
        wsPingInterval = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "ping" }));
          }
        }, 30_000);
      };

      ws.onclose = () => {
        console.log("üî¥ WebSocket fechado");
        clearInterval(wsPingInterval);
        wsPingInterval = null;

        if (!wsReconnectInterval) {
          status.textContent = "üîÅ Reconectando em 5s...";
          wsReconnectInterval = setInterval(() => {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
              connectWebSocket(sessionId);
            }
          }, 5000);
        }
      };

      ws.onerror = (err) => {
        console.error("‚ùå Erro no WebSocket:", err);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (!data.sessionId || data.sessionId !== sessionId) return;

        console.log("üì° Recebido:", data.type);

        switch (data.type) {
          case "qr_code":
            status.textContent = "üì± Escaneie o QR para conectar.";
            currentBatchStatusEl.textContent = "Aguardando login...";
            stopBtn.style.display = "none";
            disconnectBtn.style.display = "none";
            break;

          case "connected":
            status.textContent = "‚úÖ Conectado ao WhatsApp!";
            currentBatchStatusEl.textContent = "Pronto para adicionar.";
            stopBtn.style.display = "inline-block";
            disconnectBtn.style.display = "inline-block";
            break;

          case "disconnected":
            status.textContent = "üî¥ Desconectado do WhatsApp.";
            currentBatchStatusEl.textContent = "Desconectado";
            stopBtn.style.display = "none";
            disconnectBtn.style.display = "none";
            clearInterval(countdownInterval);
            break;

          case "adding_now":
            currentBatchStatusEl.textContent = `üìû Adicionando: ${data.numberAtual}`;
            break;

          case "batch_start":
            status.textContent = `üöÄ Iniciando lote de ${data.count} n√∫meros...`;
            break;

          case "batch_done":
            addedCount += data.lastBatchCount || 0;
            const remaining = Math.max(0, totalQueued - addedCount);
            totalQueuedEl.textContent = totalQueued;
            addedCountEl.textContent = addedCount;
            remainingCountEl.textContent = remaining;

            if (data.nextAddInMs) {
              estimatedTimeEl.textContent = formatTime(data.nextAddInMs / 1000);
              startCountdown(data.nextAddInMs);
            } else {
              estimatedTimeEl.textContent = "--";
            }

            result.textContent = "üü¢ Lote conclu√≠do\n" + 
              (data.results || []).map(r => `${r.number} ‚Üí ${r.status}`).join('\n');

            if (remaining === 0) {
              status.textContent = "üéâ Todos os n√∫meros foram processados!";
              currentBatchStatusEl.textContent = "Finalizado";
            }
            break;

          case "stopped":
            status.textContent = "‚è∏ Adi√ß√£o interrompida pelo usu√°rio.";
            currentBatchStatusEl.textContent = "Parado";
            stopBtn.style.display = "none";
            clearInterval(countdownInterval);
            break;
        }
      };
    }

    // Parar adi√ß√£o
    stopBtn.addEventListener('click', async () => {
      const sessionId = sessionIdSelect.value;
      try {
        const res = await fetch(`/stop/${sessionId}`, { method: 'POST' });
        if (res.ok) {
          status.textContent = "‚è∏ Envios interrompidos.";
        }
      } catch (err) {
        status.textContent = "‚ùå Falha ao parar.";
      }
    });

    // Desconectar conta
    disconnectBtn.addEventListener('click', async () => {
      const sessionId = sessionIdSelect.value;
      if (confirm(`Tem certeza que deseja desconectar a conta ${sessionId}?`)) {
        try {
          const res = await fetch(`/disconnect/${sessionId}`, { method: 'POST' });
          if (res.ok) {
            status.textContent = "üîì Conta desconectada.";
            currentBatchStatusEl.textContent = "Desconectado";
            stopBtn.style.display = "none";
            disconnectBtn.style.display = "none";
          } else {
            alert("Erro ao desconectar.");
          }
        } catch (err) {
          alert("Falha ao desconectar: " + err.message);
        }
      }
    });

    // Trocar de conta
    sessionIdSelect.addEventListener('change', () => {
      totalQueued = 0;
      addedCount = 0;
      updateStats();
      connectWebSocket(sessionIdSelect.value);
    });

    // Atualizar estat√≠sticas
    function updateStats() {
      totalQueuedEl.textContent = totalQueued;
      addedCountEl.textContent = addedCount;
      remainingCountEl.textContent = Math.max(0, totalQueued - addedCount);
    }

    // Enviar n√∫meros
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearInterval(countdownInterval);
      result.textContent = "";
      submitBtn.disabled = true;
      stopBtn.style.display = "inline-block";
      disconnectBtn.style.display = "inline-block";

      const sessionId = sessionIdSelect.value;
      const groupId = document.getElementById('groupId').value.trim();
      const numbers = Array.from(
        new Set(
          document.getElementById('numbers').value
            .split(',')
            .map(n => n.trim())
            .filter(n => n && /^\d+$/.test(n))
        )
      );

      if (numbers.length === 0) {
        status.textContent = "‚ùå Nenhum n√∫mero v√°lido.";
        submitBtn.disabled = false;
        return;
      }

      totalQueued = numbers.length;
      addedCount = 0;
      updateStats();
      estimatedTimeEl.textContent = "--";
      currentBatchStatusEl.textContent = "Enviado para fila...";

      try {
        const res = await fetch(`/adicionar/${sessionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId, numbers })
        });

        const data = await res.json();

        if (res.status === 429) {
          status.textContent = `‚è≥ Aguarde ${data.nextAddInSeconds}s...`;
          startCountdown(data.nextAddInSeconds * 1000);
        } else if (res.ok) {
          status.textContent = "‚úÖ Processo iniciado. Aguarde os lotes.";
        } else {
          status.textContent = "‚ùå Erro: " + (data.error || "Desconhecido");
          submitBtn.disabled = false;
          stopBtn.style.display = "none";
          disconnectBtn.style.display = "none";
        }
      } catch (err) {
        status.textContent = "‚ùå Falha de conex√£o: " + err.message;
        console.error("Erro de rede:", err);
        submitBtn.disabled = false;
        stopBtn.style.display = "none";
        disconnectBtn.style.display = "none";
      }
    });

    // Contagem regressiva
    function startCountdown(ms) {
      clearInterval(countdownInterval);
      let s = Math.floor(ms / 1000);
      estimatedTimeEl.textContent = formatTime(s);

      countdownInterval = setInterval(() => {
        s--;
        if (s <= 0) {
          clearInterval(countdownInterval);
          status.textContent = "‚úÖ Pronto para novo envio.";
          submitBtn.disabled = false;
          estimatedTimeEl.textContent = "0m 0s";
        } else {
          estimatedTimeEl.textContent = formatTime(s);
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}m ${s}s`;
    }

    // Iniciar WebSocket
    connectWebSocket(sessionIdSelect.value);
  </script>
</body>
</html>
