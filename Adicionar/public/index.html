<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Adicionar ao Grupo WhatsApp</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      margin: 30px 0 15px;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    form {
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 600;
      color: #ddd;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 1rem;
    }
    textarea { resize: vertical; }
    button {
      background: #6c63ff;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: background 0.3s;
    }
    button:disabled { background: #999; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #5750d1; }
    #status {
      margin-top: 15px;
      min-height: 20px;
      font-size: 0.9rem;
      text-align: center;
    }
    #liveStats {
      margin-top: 20px;
      text-align: center;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      max-width: 500px;
      width: 100%;
    }
    pre {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 10px;
      max-width: 500px;
      width: 100%;
      margin-top: 20px;
      font-size: 0.9rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>Adicionar ao Grupo WhatsApp</h2>
  <form id="groupForm">
    <label>ID do Grupo:</label>
    <input type="text" id="groupId" placeholder="1234567890@g.us" required />
    <label>N√∫meros (separados por v√≠rgula):</label>
    <textarea id="numbers" rows="4" placeholder="258840000000, 258870000000" required></textarea>
    <button type="submit" id="submitBtn">Enviar</button>
    <div id="status"></div>
  </form>

  <div id="liveStats">
    <p>üì¶ Fila: <strong id="totalQueued">0</strong></p>
    <p>‚úÖ Adicionados: <strong id="addedCount">0</strong></p>
    <p>‚åõ Restantes: <strong id="remainingCount">0</strong></p>
    <p>‚è±Ô∏è Pr√≥ximo em: <strong id="estimatedTime">--</strong></p>
    <p>üöÄ Status: <strong id="currentBatchStatus">Desconectado</strong></p>
  </div>

  <pre id="result"></pre>

  <script>
    const form = document.getElementById('groupForm');
    const result = document.getElementById('result');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const totalQueuedEl = document.getElementById('totalQueued');
    const addedCountEl = document.getElementById('addedCount');
    const remainingCountEl = document.getElementById('remainingCount');
    const estimatedTimeEl = document.getElementById('estimatedTime');
    const currentBatchStatusEl = document.getElementById('currentBatchStatus');

    let totalQueued = 0;
    let addedCount = 0;
    let countdownInterval = null;

    // ‚úÖ WebSocket seguro (WSS) para Render
    function connectWebSocket() {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const host = window.location.host;
      const ws = new WebSocket(`${protocol}//${host}`);

      ws.onopen = () => {
        console.log("üü¢ WebSocket conectado");
        status.textContent = "WebSocket conectado. Aguarde o QR...";
      };

      ws.onclose = () => {
        console.log("üî¥ WebSocket desconectado. Tentando reconectar...");
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (err) => {
        console.error("üî¥ Erro no WebSocket:", err);
        status.textContent = "Erro de conex√£o com o servidor.";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("üì° Recebido:", data.type);

        if (data.type === "qr_code") {
          status.textContent = "üì± Escaneie o QR em /qr";
          currentBatchStatusEl.textContent = "Aguardando login...";
        }
        if (data.type === "connected") {
          status.textContent = "‚úÖ Conectado ao WhatsApp!";
          currentBatchStatusEl.textContent = "Pronto para enviar.";
        }
        if (data.type === "adding_now") {
          currentBatchStatusEl.textContent = `Adicionando: ${data.numberAtual}`;
        }
        if (data.type === "batch_done") {
          addedCount += data.lastBatchCount;
          const remaining = Math.max(0, totalQueued - addedCount);
          totalQueuedEl.textContent = totalQueued;
          addedCountEl.textContent = addedCount;
          remainingCountEl.textContent = remaining;
          estimatedTimeEl.textContent = formatTime(data.nextAddInMs / 1000);
          result.textContent = "üü¢ Lote finalizado\n" + 
            data.results.map(r => `${r.number} ‚Äî ${r.status}`).join('\n');

          startCountdown(data.nextAddInMs);
          setTimeout(() => {
            if (remaining === 0) {
              status.textContent = "üéâ Todos os n√∫meros foram processados!";
              currentBatchStatusEl.textContent = "Finalizado";
            }
          }, data.nextAddInMs);
        }
      };
    }
    connectWebSocket();

    // Form
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearInterval(countdownInterval);
      result.textContent = "";
      status.textContent = "‚è≥ Enviando ao servidor...";
      submitBtn.disabled = true;

      const groupId = document.getElementById('groupId').value.trim();
      const numbers = Array.from(
        new Set(
          document.getElementById('numbers').value
            .split(',')
            .map(n => n.trim())
            .filter(n => n && /^\d+$/.test(n))
        )
      );

      if (numbers.length === 0) {
        status.textContent = "‚ùå Nenhum n√∫mero v√°lido.";
        submitBtn.disabled = false;
        return;
      }

      totalQueued = numbers.length;
      addedCount = 0;
      totalQueuedEl.textContent = totalQueued;
      addedCountEl.textContent = "0";
      remainingCountEl.textContent = totalQueued;
      estimatedTimeEl.textContent = "--";
      currentBatchStatusEl.textContent = "Processando...";

      try {
        const res = await fetch('/adicionar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId, numbers })
        });

        const data = await res.json();

        if (res.status === 429) {
          status.textContent = `‚è≥ Aguarde ${data.nextAddInSeconds}s...`;
          startCountdown(data.nextAddInSeconds * 1000);
        } else if (res.ok) {
          status.textContent = "‚úÖ Processo iniciado. Aguarde os lotes.";
        } else {
          status.textContent = "‚ùå Erro: " + (data.error || "Desconhecido");
          submitBtn.disabled = false;
        }
      } catch (err) {
        status.textContent = "‚ùå Falha de conex√£o: " + err.message;
        console.error("Erro de rede:", err);
        submitBtn.disabled = false;
      }
    });

    function startCountdown(ms) {
      clearInterval(countdownInterval);
      let s = Math.floor(ms / 1000);
      countdownInterval = setInterval(() => {
        if (s <= 0) {
          clearInterval(countdownInterval);
          status.textContent = "‚úÖ Pronto para novo envio.";
          submitBtn.disabled = false;
        } else {
          status.textContent = `‚è≥ Aguarde ${formatTime(s)}...`;
          s--;
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}m ${s}s`;
    }
  </script>
</body>
</html>
